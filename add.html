<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مدیریت پیام‌های تبریک</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      /* justify-content: center; Remove this to allow scrolling for list */
      padding-top: 20px; /* Add padding for better spacing */
      min-height: 100vh;
      background-image: url('https://www.transparenttextures.com/patterns/padded-light.png'), linear-gradient(to top left, #a1c4fd, #c2e9fb);
      background-attachment: fixed;
    }
    .page-container {
        width: 95%;
        max-width: 800px; /* Wider container for list */
        margin: 0 auto;
    }
    .form-container {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px 30px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      width: 100%; /* Full width within page-container */
      margin-bottom: 30px;
    }
    .form-title {
      text-align: center;
      color: #3f51b5;
      margin-bottom: 25px;
      font-size: 1.8rem;
    }
    .view-notes-link-container {
      margin-top: 25px;
      text-align: center;
      padding-bottom: 20px; /* Space at the bottom */
    }
    .view-notes-link {
      display: inline-block;
      padding: 10px 20px;
      background-color: #66bb6a;
      color: white;
      text-decoration: none;
      border-radius: 20px;
      font-size: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: background-color 0.2s ease;
    }
    .view-notes-link:hover {
      background-color: #4caf50;
    }
    #message-box {
        margin-top: 15px;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
        display: none; 
    }
    #message-box.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    #message-box.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    /* Styles for the notes list */
    #admin-notes-list-container {
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        margin-top: 30px;
    }
    .admin-note-item {
        border: 1px solid #eee;
        background-color: #fff;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .admin-note-item .note-content {
        flex-grow: 1;
    }
    .admin-note-item .note-name {
        font-weight: bold;
        color: #3f51b5;
        font-size: 1.1rem;
    }
    .admin-note-item .note-message {
        font-size: 0.95rem;
        color: #555;
        white-space: pre-wrap; /* Preserve line breaks */
    }
    .admin-note-item .note-image-url {
        font-size: 0.8rem;
        color: #777;
        word-break: break-all;
    }
    .admin-note-item .note-actions button {
        padding: 6px 12px;
        margin-right: 8px; /* RTL: margin-left */
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: opacity 0.2s ease;
    }
    .admin-note-item .note-actions button:hover {
        opacity: 0.8;
    }
    .edit-button {
        background-color: #ffc107; /* Amber */
        color: #333;
    }
    .delete-button {
        background-color: #f44336; /* Red */
        color: white;
    }
    .cancel-edit-button {
        background-color: #9e9e9e; /* Grey */
        color: white;
        display: none; /* Hidden by default */
    }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="form-container">
      <h1 class="form-title" id="form-main-title">💌 پیامت رو اینجا بنویس! 💌</h1>
      <form id="note-form">
        <input type="hidden" id="noteId" /> <div class="form-group">
          <label for="name">نام شما:</label>
          <input type="text" id="name" placeholder="مثلا: بهترین دوست" required />
        </div>
        <div class="form-group">
          <label for="message">پیام تبریک:</label>
          <textarea id="message" placeholder="یه عالمه آرزوی خوب..." rows="4" required></textarea>
        </div>
        <div class="form-group">
          <label for="imageURL">لینک عکس پروفایل (اختیاری):</label>
          <input type="url" id="imageURL" placeholder="https://example.com/avatar.jpg" />
          <small>یک لینک مستقیم به فایل عکس (png, jpg, gif)</small>
        </div>
        <button type="submit" id="submit-button">ارسال پیام ✨</button>
        <button type="button" id="cancel-edit-button" class="cancel-edit-button">لغو ویرایش</button>
      </form>
      <div id="message-box"></div>
    </div>

    <div id="admin-notes-list-container">
      <h2 style="text-align:center; color: #3f51b5; margin-bottom: 20px;">لیست پیام‌ها</h2>
      <div id="admin-notes-list">
        </div>
    </div>

    <div class="view-notes-link-container">
      <a href="index.html" class="view-notes-link">مشاهده تخته عمومی پیام‌ها</a>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBux-_Rlnw0nIv-F1dSdcRAbvLPSSTpZ8I",
      authDomain: "sticky-e06b0.firebaseapp.com",
      projectId: "sticky-e06b0",
      storageBucket: "sticky-e06b0.firebasestorage.app",
      messagingSenderId: "632807722451",
      appId: "1:632807722451:web:be9d003c442eb14987f326"
    };

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-birthday-board';

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const noteForm = document.getElementById('note-form');
    const submitButton = document.getElementById('submit-button');
    const cancelEditButton = document.getElementById('cancel-edit-button');
    const messageBox = document.getElementById('message-box');
    const noteIdField = document.getElementById('noteId');
    const nameField = document.getElementById('name');
    const messageField = document.getElementById('message');
    const imageURLField = document.getElementById('imageURL');
    const adminNotesListDiv = document.getElementById('admin-notes-list');
    const formMainTitle = document.getElementById('form-main-title');

    let currentEditId = null; // To track if we are in edit mode

    function showMessage(message, type = "success") {
      messageBox.textContent = message;
      messageBox.className = type; 
      messageBox.style.display = 'block';
      setTimeout(() => {
        messageBox.style.display = 'none';
      }, 4000);
    }

    function resetForm() {
        noteForm.reset();
        noteIdField.value = '';
        currentEditId = null;
        submitButton.textContent = 'ارسال پیام ✨';
        formMainTitle.textContent = '💌 پیامت رو اینجا بنویس! 💌';
        cancelEditButton.style.display = 'none';
        submitButton.disabled = false;
    }

    // Handle Form Submission (Add or Update)
    noteForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = nameField.value.trim();
      const message = messageField.value.trim();
      const imageURL = imageURLField.value.trim();

      if (name && message) {
        submitButton.disabled = true;
        const notesPath = `artifacts/${appId}/public/data/stickyNotes`;
        
        try {
          if (currentEditId) { // UPDATE existing note
            submitButton.textContent = 'در حال به‌روزرسانی...';
            const noteRef = doc(db, notesPath, currentEditId);
            await updateDoc(noteRef, {
              name,
              message,
              imageURL: imageURL || null,
              // timestamp: serverTimestamp() // Optionally update timestamp
            });
            showMessage('پیام با موفقیت به‌روزرسانی شد! 👍', 'success');
          } else { // ADD new note
            submitButton.textContent = 'در حال ارسال...';
            const notesCollectionRef = collection(db, notesPath);
            await addDoc(notesCollectionRef, {
              name,
              message,
              imageURL: imageURL || null,
              timestamp: serverTimestamp()
            });
            showMessage('پیام شما با موفقیت ارسال شد! 🎉', 'success');
          }
          resetForm();
        } catch (error) {
          console.error("Error saving document: ", error);
          showMessage('خطا در ذخیره پیام. لطفا دوباره تلاش کنید.', 'error');
          submitButton.disabled = false; // Re-enable on error
          submitButton.textContent = currentEditId ? 'به‌روزرسانی پیام 🔄' : 'ارسال پیام ✨';
        }
      } else {
        showMessage('لطفاً نام و پیام خود را وارد کنید.', 'error');
      }
    });

    cancelEditButton.addEventListener('click', () => {
        resetForm();
        window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top
    });

    // Load and Display Notes for Admin
    function loadNotesForAdmin() {
        const notesPath = `artifacts/${appId}/public/data/stickyNotes`;
        const q = query(collection(db, notesPath), orderBy('timestamp', 'desc'));

        onSnapshot(q, (snapshot) => {
            adminNotesListDiv.innerHTML = ''; // Clear previous list
            if (snapshot.empty) {
                adminNotesListDiv.innerHTML = '<p style="text-align:center; color:#777;">هنوز پیامی ثبت نشده است.</p>';
                return;
            }
            snapshot.forEach((docSnap) => {
                const note = docSnap.data();
                const noteId = docSnap.id;
                createAdminNoteElement(note, noteId);
            });
        }, (error) => {
            console.error("Error fetching notes for admin: ", error);
            showMessage("خطا در بارگذاری لیست پیام‌ها.", "error");
        });
    }

    function createAdminNoteElement(note, noteId) {
        const item = document.createElement('div');
        item.classList.add('admin-note-item');
        item.dataset.id = noteId;

        const contentDiv = document.createElement('div');
        contentDiv.classList.add('note-content');

        const nameEl = document.createElement('div');
        nameEl.classList.add('note-name');
        nameEl.textContent = note.name;
        contentDiv.appendChild(nameEl);

        const messageEl = document.createElement('div');
        messageEl.classList.add('note-message');
        messageEl.textContent = note.message;
        contentDiv.appendChild(messageEl);

        if (note.imageURL) {
            const imageEl = document.createElement('div');
            imageEl.classList.add('note-image-url');
            imageEl.innerHTML = `<strong>لینک عکس:</strong> ${note.imageURL}`;
            contentDiv.appendChild(imageEl);
        }
        
        const timestamp = note.timestamp ? note.timestamp.toDate().toLocaleString('fa-IR') : 'نامشخص';
        const timestampEl = document.createElement('div');
        timestampEl.style.fontSize = '0.8rem';
        timestampEl.style.color = '#888';
        timestampEl.textContent = `تاریخ: ${timestamp}`;
        contentDiv.appendChild(timestampEl);

        item.appendChild(contentDiv);

        const actionsDiv = document.createElement('div');
        actionsDiv.classList.add('note-actions');

        const editButton = document.createElement('button');
        editButton.classList.add('edit-button');
        editButton.textContent = 'ویرایش';
        editButton.addEventListener('click', () => {
            formMainTitle.textContent = '📝 ویرایش پیام 📝';
            nameField.value = note.name;
            messageField.value = note.message;
            imageURLField.value = note.imageURL || '';
            noteIdField.value = noteId; // Store ID in hidden field (though currentEditId is primary)
            currentEditId = noteId;
            submitButton.textContent = 'به‌روزرسانی پیام 🔄';
            cancelEditButton.style.display = 'inline-block';
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to form
            nameField.focus();
        });

        const deleteButton = document.createElement('button');
        deleteButton.classList.add('delete-button');
        deleteButton.textContent = 'حذف';
        deleteButton.addEventListener('click', async () => {
            // Custom confirmation dialog
            const confirmationMessage = `آیا از حذف پیام "${note.name}" مطمئن هستید؟ این عمل قابل بازگشت نیست.`;
            
            // Create a simple modal for confirmation
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.zIndex = '1000';
            modal.style.direction = 'rtl';

            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.padding = '20px';
            modalContent.style.borderRadius = '8px';
            modalContent.style.textAlign = 'center';
            modalContent.style.fontFamily = "'Vazirmatn', sans-serif";


            const messageP = document.createElement('p');
            messageP.textContent = confirmationMessage;
            messageP.style.marginBottom = '20px';
            modalContent.appendChild(messageP);

            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'بله، حذف کن';
            confirmBtn.style.backgroundColor = '#f44336';
            confirmBtn.style.color = 'white';
            confirmBtn.style.border = 'none';
            confirmBtn.style.padding = '10px 15px';
            confirmBtn.style.borderRadius = '5px';
            confirmBtn.style.marginLeft = '10px';
            confirmBtn.style.cursor = 'pointer';

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'انصراف';
            cancelBtn.style.backgroundColor = '#ccc';
            cancelBtn.style.border = 'none';
            cancelBtn.style.padding = '10px 15px';
            cancelBtn.style.borderRadius = '5px';
            cancelBtn.style.cursor = 'pointer';

            confirmBtn.onclick = async () => {
                document.body.removeChild(modal);
                try {
                    const notesPath = `artifacts/${appId}/public/data/stickyNotes`;
                    await deleteDoc(doc(db, notesPath, noteId));
                    showMessage('پیام با موفقیت حذف شد.', 'success');
                    // The onSnapshot listener will automatically update the list
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    showMessage('خطا در حذف پیام.', 'error');
                }
            };

            cancelBtn.onclick = () => {
                document.body.removeChild(modal);
            };

            modalContent.appendChild(confirmBtn);
            modalContent.appendChild(cancelBtn);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        });

        actionsDiv.appendChild(editButton);
        actionsDiv.appendChild(deleteButton);
        item.appendChild(actionsDiv);

        adminNotesListDiv.appendChild(item);
    }

    // Initial load of notes
    loadNotesForAdmin();

  </script>
</body>
</html>
