<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مدیریت تخته پیام‌های تبریک</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      min-height: 100vh;
      background-image: url('https://www.transparenttextures.com/patterns/padded-light.png'), linear-gradient(to top left, #a1c4fd, #c2e9fb);
      background-attachment: fixed;
    }
    .page-container {
        width: 95%;
        max-width: 800px;
        margin: 0 auto;
    }
    .board-selector-container, .form-container, #admin-notes-list-container {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px 30px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      width: 100%;
      margin-bottom: 30px;
    }
    .section-title {
      text-align: center;
      color: #3f51b5;
      margin-bottom: 25px;
      font-size: 1.8rem;
    }
    #board-selector-form label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
    }
    #board-selector-form input[type="text"] {
        width: calc(100% - 130px); /* Adjusted for button width */
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-family: 'Vazirmatn', sans-serif;
    }
    #board-selector-form button {
        padding: 10px 15px;
        background-color: #5cb85c;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 10px; /* RTL: margin-left */
    }
     #current-board-info {
        text-align: center;
        margin-bottom: 20px;
        padding: 10px;
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 8px;
    }
    #current-board-info a {
        color: #1976d2;
        text-decoration: none;
        font-weight: bold;
    }
    #current-board-info a:hover {
        text-decoration: underline;
    }
    .main-footer {
        text-align: center;
        padding: 20px;
        margin-top: 10px;
        font-family: 'Vazirmatn', sans-serif;
        color: #555;
        font-size: 0.9rem;
    }
    #admin-notes-list-container { margin-top: 0; }
    .admin-note-item {
        border: 1px solid #eee; background-color: #fff; padding: 15px; margin-bottom: 15px;
        border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex;
        flex-direction: column; gap: 8px;
    }
    .admin-note-item .note-content { flex-grow: 1; }
    .admin-note-item .note-name { font-weight: bold; color: #3f51b5; font-size: 1.1rem; }
    .admin-note-item .note-message { font-size: 0.95rem; color: #555; white-space: pre-wrap; }
    .admin-note-item .note-image-url { font-size: 0.8rem; color: #777; word-break: break-all; }
    .admin-note-item .note-actions button {
        padding: 6px 12px; margin-left: 8px; border: none;
        border-radius: 5px; cursor: pointer; font-size: 0.9rem; transition: opacity 0.2s ease;
    }
    .admin-note-item .note-actions button:hover { opacity: 0.8; }
    .edit-button { background-color: #ffc107; color: #333; }
    .delete-button { background-color: #f44336; color: white; }
    .cancel-edit-button { background-color: #9e9e9e; color: white; display: none; margin-top: 10px;}
    #message-box {
        margin-top: 15px; padding: 10px; border-radius: 5px; text-align: center;
        font-weight: bold; display: none; 
    }
    #message-box.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    #message-box.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  </style>
</head>
<body>
  <div class="page-container">
    <div class="board-selector-container" id="board-selector-wrapper">
        <h1 class="section-title">انتخاب یا ایجاد تخته یادداشت</h1>
        <form id="board-selector-form">
            <label for="boardIdInput">شناسه تخته (انگلیسی، بدون فاصله، مثلا: tavalod-ali-1403):</label>
            <input type="text" id="boardIdInput" placeholder="شناسه تخته را وارد کنید" />
            <button type="submit">برو به این تخته / ایجاد کن</button>
        </form>
    </div>

    <div id="board-management-area" style="display:none;">
        <div id="current-board-info"></div>
        <div class="form-container">
          <h1 class="section-title" id="form-main-title">💌 افزودن پیام به تخته 💌</h1>
          <form id="note-form">
            <input type="hidden" id="noteId" />
            <div class="form-group">
              <label for="name">نام شما:</label>
              <input type="text" id="name" placeholder="مثلا: بهترین دوست" required />
            </div>
            <div class="form-group">
              <label for="message">پیام تبریک:</label>
              <textarea id="message" placeholder="یه عالمه آرزوی خوب..." rows="4" required></textarea>
            </div>
            <div class="form-group">
              <label for="imageURL">لینک عکس پروفایل (اختیاری):</label>
              <input type="url" id="imageURL" placeholder="https://example.com/avatar.jpg" />
              <small>یک لینک مستقیم به فایل عکس (png, jpg, gif)</small>
            </div>
            <button type="submit" id="submit-button">ارسال پیام ✨</button>
            <button type="button" id="cancel-edit-button" class="cancel-edit-button">لغو ویرایش</button>
          </form>
          <div id="message-box"></div>
        </div>

        <div id="admin-notes-list-container">
          <h2 style="text-align:center; color: #3f51b5; margin-bottom: 20px;" id="list-title">لیست پیام‌ها</h2>
          <div id="admin-notes-list"></div>
        </div>
    </div>
  </div>
  
  <footer class="main-footer">
    ساخته شده با عشق توسط امید و مهلا ❤️
  </footer>

  <script type="module">
    // ! مهم: این آدرس را با آدرس سرور پروکسی خود در Railway جایگزین کنید
    const PROXY_BASE_URL = 'https://sticky-proxyserver-production.up.railway.app/api'; // مثال: 'https://my-notes-proxy.up.railway.app/api'
                                                                      // /api را به انتهای آدرس اضافه کنید

    const boardSelectorForm = document.getElementById('board-selector-form');
    const boardIdInputField = document.getElementById('boardIdInput');
    const boardSelectorWrapper = document.getElementById('board-selector-wrapper');
    const boardManagementArea = document.getElementById('board-management-area');
    const currentBoardInfoDiv = document.getElementById('current-board-info');
    
    const noteForm = document.getElementById('note-form');
    const submitButton = document.getElementById('submit-button');
    const cancelEditButton = document.getElementById('cancel-edit-button');
    const messageBox = document.getElementById('message-box');
    const noteIdField = document.getElementById('noteId'); // This is the hidden input
    const nameField = document.getElementById('name');
    const messageField = document.getElementById('message');
    const imageURLField = document.getElementById('imageURL');
    const adminNotesListDiv = document.getElementById('admin-notes-list');
    const formMainTitle = document.getElementById('form-main-title');
    const listTitle = document.getElementById('list-title');

    let activeBoardId = null;
    let currentEditId = null; // Stores the ID of the note being edited

    function getBoardIdFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('boardId');
    }

    function sanitizeBoardId(id) {
        if (!id) return '';
        return id.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
    }

    boardSelectorForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const inputBoardId = boardIdInputField.value;
        const sanitizedBoardId = sanitizeBoardId(inputBoardId);
        if (sanitizedBoardId) {
            window.location.search = `?boardId=${sanitizedBoardId}`;
        } else {
            showMessage('لطفاً یک شناسه معتبر برای تخته وارد کنید.', 'error');
        }
    });

    function initializeBoard(boardId) {
        activeBoardId = boardId;
        boardSelectorWrapper.style.display = 'none';
        boardManagementArea.style.display = 'block';

        const publicViewLink = `index.html?boardId=${activeBoardId}`;
        currentBoardInfoDiv.innerHTML = `
            شما در حال مدیریت تخته: <strong>${activeBoardId}</strong> هستید. <br>
            <a href="${publicViewLink}" target="_blank">مشاهده عمومی این تخته</a> | 
            <a href="manage.html">انتخاب تخته دیگر</a>
        `;
        formMainTitle.textContent = `💌 افزودن پیام به تخته "${activeBoardId}" 💌`;
        listTitle.textContent = `لیست پیام‌های تخته "${activeBoardId}"`;
        
        resetForm();
        loadNotesForAdmin();
    }
    
    function showMessage(message, type = "success", targetMessageBox = messageBox) {
      targetMessageBox.textContent = message;
      targetMessageBox.className = `message-box ${type}`; // Ensure base class is there
      targetMessageBox.style.display = 'block';
      setTimeout(() => {
        targetMessageBox.style.display = 'none';
      }, 4000);
    }

    function resetForm() {
        noteForm.reset();
        noteIdField.value = ''; // Clear the hidden ID field
        currentEditId = null;
        submitButton.textContent = 'ارسال پیام ✨';
        if (activeBoardId) { // Update title only if a board is active
            formMainTitle.textContent = `💌 افزودن پیام به تخته "${activeBoardId}" 💌`;
        } else {
            formMainTitle.textContent = '💌 پیامت رو اینجا بنویس! 💌';
        }
        cancelEditButton.style.display = 'none';
        submitButton.disabled = false;
    }

    noteForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!activeBoardId) {
          showMessage('ابتدا یک تخته را انتخاب یا ایجاد کنید.', 'error');
          return;
      }
      const name = nameField.value.trim();
      const message = messageField.value.trim();
      const imageURL = imageURLField.value.trim();
      const noteData = { name, message, imageURL: imageURL || null };

      if (name && message) {
        submitButton.disabled = true;
        let url, method;

        if (currentEditId) { // UPDATE
          url = `${PROXY_BASE_URL}/notes/${activeBoardId}/${currentEditId}`;
          method = 'PUT';
          submitButton.textContent = 'در حال به‌روزرسانی...';
        } else { // ADD
          url = `${PROXY_BASE_URL}/notes/${activeBoardId}`;
          method = 'POST';
          submitButton.textContent = 'در حال ارسال...';
        }

        try {
          const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(noteData)
          });
          
          if (!response.ok) {
            const errorData = await response.json().catch(() => ({error: "خطای ناشناخته در پاسخ سرور"}));
            throw new Error(errorData.error || `خطای سرور: ${response.status}`);
          }
          
          // const result = await response.json(); // The proxy sends back the note or a success message
          showMessage(currentEditId ? 'پیام با موفقیت به‌روزرسانی شد! 👍' : 'پیام شما با موفقیت ارسال شد! 🎉', 'success');
          resetForm();
          loadNotesForAdmin(); // Refresh list after add/update
        } catch (error) {
          console.error("Error saving document via proxy: ", error);
          showMessage(`خطا در ذخیره پیام: ${error.message}`, 'error');
          submitButton.disabled = false;
          submitButton.textContent = currentEditId ? 'به‌روزرسانی پیام 🔄' : 'ارسال پیام ✨';
        }
      } else {
        showMessage('لطفاً نام و پیام خود را وارد کنید.', 'error');
      }
    });

    cancelEditButton.addEventListener('click', () => {
        resetForm();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    async function loadNotesForAdmin() {
        if (!activeBoardId) return;
        adminNotesListDiv.innerHTML = `<p style="text-align:center; color:#777;">در حال بارگذاری پیام‌ها برای تخته "${activeBoardId}"...</p>`;
        try {
            const response = await fetch(`${PROXY_BASE_URL}/notes/${activeBoardId}`);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({error: "خطای ناشناخته"}));
                throw new Error(errorData.error || `خطای سرور: ${response.status}`);
            }
            const notes = await response.json();
            adminNotesListDiv.innerHTML = ''; // Clear loading message
            if (!notes || notes.length === 0) {
                adminNotesListDiv.innerHTML = `<p style="text-align:center; color:#777;">هنوز پیامی برای تخته "${activeBoardId}" ثبت نشده است.</p>`;
                return;
            }
            notes.forEach(note => createAdminNoteElement(note, note.id));
        } catch (error) {
            console.error(`Error fetching notes for admin (board: ${activeBoardId}): `, error);
            showMessage(`خطا در بارگذاری لیست پیام‌ها: ${error.message}`, "error");
            adminNotesListDiv.innerHTML = `<p style="text-align:center; color:red;">خطا در بارگذاری پیام‌ها. ${error.message}</p>`;
        }
    }

    function createAdminNoteElement(note, noteId) {
        const item = document.createElement('div');
        item.classList.add('admin-note-item');
        item.dataset.id = noteId;
        
        const contentDiv = document.createElement('div');
        contentDiv.classList.add('note-content');
        const nameEl = document.createElement('div');
        nameEl.classList.add('note-name'); nameEl.textContent = note.name; contentDiv.appendChild(nameEl);
        const messageEl = document.createElement('div');
        messageEl.classList.add('note-message'); messageEl.textContent = note.message; contentDiv.appendChild(messageEl);
        if (note.imageURL) {
            const imageEl = document.createElement('div');
            imageEl.classList.add('note-image-url'); imageEl.innerHTML = `<strong>لینک عکس:</strong> ${note.imageURL}`; contentDiv.appendChild(imageEl);
        }
        // Timestamps from Firestore are objects, need to convert if they exist and are valid
        let formattedTimestamp = 'نامشخص';
        if (note.timestamp && note.timestamp._seconds) { // Firestore timestamp object from Admin SDK
             formattedTimestamp = new Date(note.timestamp._seconds * 1000).toLocaleString('fa-IR');
        } else if (typeof note.timestamp === 'string' && note.timestamp.includes("Pending")) {
            formattedTimestamp = "درحال ثبت توسط سرور";
        } else if (note.timestamp) { // If it's already a string or number from a previous fetch
            try { formattedTimestamp = new Date(note.timestamp).toLocaleString('fa-IR'); } catch (e) { /* ignore */ }
        }

        const timestampEl = document.createElement('div');
        timestampEl.style.fontSize = '0.8rem'; timestampEl.style.color = '#888';
        timestampEl.textContent = `تاریخ: ${formattedTimestamp}`; contentDiv.appendChild(timestampEl);
        item.appendChild(contentDiv);

        const actionsDiv = document.createElement('div'); actionsDiv.classList.add('note-actions');
        const editButton = document.createElement('button');
        editButton.classList.add('edit-button'); editButton.textContent = 'ویرایش';
        editButton.addEventListener('click', () => {
            formMainTitle.textContent = `📝 ویرایش پیام در تخته "${activeBoardId}" 📝`;
            nameField.value = note.name; messageField.value = note.message; imageURLField.value = note.imageURL || '';
            noteIdField.value = noteId; currentEditId = noteId; // Set currentEditId
            submitButton.textContent = 'به‌روزرسانی پیام 🔄'; cancelEditButton.style.display = 'inline-block';
            window.scrollTo({ top: 0, behavior: 'smooth' }); nameField.focus();
        });

        const deleteButton = document.createElement('button');
        deleteButton.classList.add('delete-button'); deleteButton.textContent = 'حذف';
        deleteButton.addEventListener('click', async () => {
            // Custom confirmation dialog
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;direction:rtl;';
            const modalContent = document.createElement('div');
            modalContent.style.cssText = "background-color:white;padding:20px;border-radius:8px;text-align:center;font-family:'Vazirmatn',sans-serif;";
            const messageP = document.createElement('p');
            messageP.textContent = `آیا از حذف پیام "${note.name}" از تخته "${activeBoardId}" مطمئن هستید؟`; messageP.style.marginBottom = '20px'; modalContent.appendChild(messageP);
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'بله، حذف کن'; confirmBtn.style.cssText = 'background-color:#f44336;color:white;border:none;padding:10px 15px;border-radius:5px;margin-left:10px;cursor:pointer;';
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'انصراف'; cancelBtn.style.cssText = 'background-color:#ccc;border:none;padding:10px 15px;border-radius:5px;cursor:pointer;';
            
            confirmBtn.onclick = async () => {
                document.body.removeChild(modal);
                try {
                    const response = await fetch(`${PROXY_BASE_URL}/notes/${activeBoardId}/${noteId}`, { method: 'DELETE' });
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({error: "خطای ناشناخته"}));
                        throw new Error(errorData.error || `Server error: ${response.status}`);
                    }
                    showMessage('پیام با موفقیت حذف شد.', 'success');
                    loadNotesForAdmin(); // Refresh list
                } catch (error) { 
                    console.error("Error deleting document via proxy: ", error); 
                    showMessage(`خطا در حذف پیام: ${error.message}`, 'error'); 
                }
            };
            cancelBtn.onclick = () => { document.body.removeChild(modal); };
            modalContent.appendChild(confirmBtn); modalContent.appendChild(cancelBtn);
            modal.appendChild(modalContent); document.body.appendChild(modal);
        });
        actionsDiv.appendChild(editButton); actionsDiv.appendChild(deleteButton); item.appendChild(actionsDiv);
        adminNotesListDiv.appendChild(item);
    }

    const initialBoardIdFromUrl = getBoardIdFromURL();
    if (initialBoardIdFromUrl) {
        const sanitizedInitialId = sanitizeBoardId(initialBoardIdFromUrl);
        boardIdInputField.value = sanitizedInitialId; // Pre-fill for clarity
        initializeBoard(sanitizedInitialId);
    } else {
        boardSelectorWrapper.style.display = 'block';
        boardManagementArea.style.display = 'none';
    }
  </script>
</body>
</html>
