<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مدیریت تخته پیام‌های تبریک</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
      min-height: 100vh;
      background-image: url('https://www.transparenttextures.com/patterns/padded-light.png'), linear-gradient(to top left, #a1c4fd, #c2e9fb);
      background-attachment: fixed;
    }
    .page-container {
        width: 95%;
        max-width: 800px;
        margin: 0 auto;
    }
    .board-selector-container, .form-container, #admin-notes-list-container {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px 30px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      width: 100%;
      margin-bottom: 30px;
    }
    .section-title {
      text-align: center;
      color: #3f51b5;
      margin-bottom: 25px;
      font-size: 1.8rem;
    }
    #board-selector-form label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
    }
    #board-selector-form input[type="text"] {
        width: calc(100% - 110px); /* Adjust based on button width */
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        font-family: 'Vazirmatn', sans-serif;
    }
    #board-selector-form button {
        padding: 10px 15px;
        background-color: #5cb85c;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 10px; /* RTL: margin-left */
    }
     #current-board-info {
        text-align: center;
        margin-bottom: 20px;
        padding: 10px;
        background-color: #e3f2fd;
        border: 1px solid #90caf9;
        border-radius: 8px;
    }
    #current-board-info a {
        color: #1976d2;
        text-decoration: none;
        font-weight: bold;
    }
    #current-board-info a:hover {
        text-decoration: underline;
    }

    /* (Styles from previous add.html for form and list are mostly reused via style.css or are similar) */
    /* Styles for the notes list */
    #admin-notes-list-container { margin-top: 0; } /* Already has margin-bottom from .form-container */
    .admin-note-item {
        border: 1px solid #eee; background-color: #fff; padding: 15px; margin-bottom: 15px;
        border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex;
        flex-direction: column; gap: 8px;
    }
    .admin-note-item .note-content { flex-grow: 1; }
    .admin-note-item .note-name { font-weight: bold; color: #3f51b5; font-size: 1.1rem; }
    .admin-note-item .note-message { font-size: 0.95rem; color: #555; white-space: pre-wrap; }
    .admin-note-item .note-image-url { font-size: 0.8rem; color: #777; word-break: break-all; }
    .admin-note-item .note-actions button {
        padding: 6px 12px; margin-left: 8px; /* RTL: margin-left */ border: none;
        border-radius: 5px; cursor: pointer; font-size: 0.9rem; transition: opacity 0.2s ease;
    }
    .admin-note-item .note-actions button:hover { opacity: 0.8; }
    .edit-button { background-color: #ffc107; color: #333; }
    .delete-button { background-color: #f44336; color: white; }
    .cancel-edit-button { background-color: #9e9e9e; color: white; display: none; }
    #message-box {
        margin-top: 15px; padding: 10px; border-radius: 5px; text-align: center;
        font-weight: bold; display: none; 
    }
    #message-box.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    #message-box.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

  </style>
</head>
<body>
  <div class="page-container">
    <div class="board-selector-container" id="board-selector-wrapper">
        <h1 class="section-title">انتخاب یا ایجاد تخته یادداشت</h1>
        <form id="board-selector-form">
            <label for="boardIdInput">شناسه تخته (انگلیسی، بدون فاصله، مثلا: tavalod-ali-1403):</label>
            <input type="text" id="boardIdInput" placeholder="شناسه تخته را وارد کنید" />
            <button type="submit">برو به این تخته / ایجاد کن</button>
        </form>
    </div>

    <div id="board-management-area" style="display:none;"> <div id="current-board-info"></div>
        <div class="form-container">
          <h1 class="section-title" id="form-main-title">💌 افزودن پیام به تخته 💌</h1>
          <form id="note-form">
            <input type="hidden" id="noteId" />
            <div class="form-group">
              <label for="name">نام شما:</label>
              <input type="text" id="name" placeholder="مثلا: بهترین دوست" required />
            </div>
            <div class="form-group">
              <label for="message">پیام تبریک:</label>
              <textarea id="message" placeholder="یه عالمه آرزوی خوب..." rows="4" required></textarea>
            </div>
            <div class="form-group">
              <label for="imageURL">لینک عکس پروفایل (اختیاری):</label>
              <input type="url" id="imageURL" placeholder="https://example.com/avatar.jpg" />
              <small>یک لینک مستقیم به فایل عکس (png, jpg, gif)</small>
            </div>
            <button type="submit" id="submit-button">ارسال پیام ✨</button>
            <button type="button" id="cancel-edit-button" class="cancel-edit-button">لغو ویرایش</button>
          </form>
          <div id="message-box"></div>
        </div>

        <div id="admin-notes-list-container">
          <h2 style="text-align:center; color: #3f51b5; margin-bottom: 20px;" id="list-title">لیست پیام‌ها</h2>
          <div id="admin-notes-list"></div>
        </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, doc, deleteDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = { // Using your provided config
      apiKey: "AIzaSyBux-_Rlnw0nIv-F1dSdcRAbvLPSSTpZ8I",
      authDomain: "sticky-e06b0.firebaseapp.com",
      projectId: "sticky-e06b0",
      storageBucket: "sticky-e06b0.firebasestorage.app",
      messagingSenderId: "632807722451",
      appId: "1:632807722451:web:be9d003c442eb14987f326"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const boardSelectorForm = document.getElementById('board-selector-form');
    const boardIdInputField = document.getElementById('boardIdInput');
    const boardSelectorWrapper = document.getElementById('board-selector-wrapper');
    const boardManagementArea = document.getElementById('board-management-area');
    const currentBoardInfoDiv = document.getElementById('current-board-info');
    
    const noteForm = document.getElementById('note-form');
    const submitButton = document.getElementById('submit-button');
    const cancelEditButton = document.getElementById('cancel-edit-button');
    const messageBox = document.getElementById('message-box');
    const noteIdField = document.getElementById('noteId');
    const nameField = document.getElementById('name');
    const messageField = document.getElementById('message');
    const imageURLField = document.getElementById('imageURL');
    const adminNotesListDiv = document.getElementById('admin-notes-list');
    const formMainTitle = document.getElementById('form-main-title');
    const listTitle = document.getElementById('list-title');

    let activeBoardId = null;
    let currentEditId = null; 
    let unsubscribeNotesListener = null; // To detach listener when changing boards

    function getBoardIdFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('boardId');
    }

    function sanitizeBoardId(id) {
        return id.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
    }

    boardSelectorForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const inputBoardId = boardIdInputField.value;
        const sanitizedBoardId = sanitizeBoardId(inputBoardId);
        if (sanitizedBoardId) {
            // Update URL and reload or just initialize board
            window.location.search = `?boardId=${sanitizedBoardId}`;
        } else {
            showMessage('لطفاً یک شناسه معتبر برای تخته وارد کنید.', 'error', messageBox); // Use specific messageBox
        }
    });

    function initializeBoard(boardId) {
        activeBoardId = boardId;
        boardSelectorWrapper.style.display = 'none';
        boardManagementArea.style.display = 'block';

        const publicViewLink = `index.html?boardId=${activeBoardId}`;
        currentBoardInfoDiv.innerHTML = `
            شما در حال مدیریت تخته: <strong>${activeBoardId}</strong> هستید. <br>
            <a href="${publicViewLink}" target="_blank">مشاهده عمومی این تخته</a> | 
            <a href="manage.html">انتخاب تخته دیگر</a>
        `;
        formMainTitle.textContent = `💌 افزودن پیام به تخته "${activeBoardId}" 💌`;
        listTitle.textContent = `لیست پیام‌های تخته "${activeBoardId}"`;
        
        resetForm(); // Clear form for the new board
        loadNotesForAdmin();
    }
    
    function showMessage(message, type = "success", targetMessageBox = messageBox) {
      targetMessageBox.textContent = message;
      targetMessageBox.className = type; 
      targetMessageBox.style.display = 'block';
      setTimeout(() => {
        targetMessageBox.style.display = 'none';
      }, 4000);
    }

    function resetForm() {
        noteForm.reset();
        noteIdField.value = '';
        currentEditId = null;
        submitButton.textContent = 'ارسال پیام ✨';
        formMainTitle.textContent = `💌 افزودن پیام به تخته "${activeBoardId}" 💌`;
        cancelEditButton.style.display = 'none';
        submitButton.disabled = false;
    }

    noteForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!activeBoardId) {
          showMessage('ابتدا یک تخته را انتخاب یا ایجاد کنید.', 'error');
          return;
      }
      const name = nameField.value.trim();
      const message = messageField.value.trim();
      const imageURL = imageURLField.value.trim();

      if (name && message) {
        submitButton.disabled = true;
        const notesPath = `artifacts/${activeBoardId}/public/data/stickyNotes`;
        try {
          if (currentEditId) {
            submitButton.textContent = 'در حال به‌روزرسانی...';
            const noteRef = doc(db, notesPath, currentEditId);
            await updateDoc(noteRef, { name, message, imageURL: imageURL || null });
            showMessage('پیام با موفقیت به‌روزرسانی شد! 👍', 'success');
          } else {
            submitButton.textContent = 'در حال ارسال...';
            const notesCollectionRef = collection(db, notesPath);
            await addDoc(notesCollectionRef, { name, message, imageURL: imageURL || null, timestamp: serverTimestamp() });
            showMessage('پیام شما با موفقیت ارسال شد! 🎉', 'success');
          }
          resetForm();
        } catch (error) {
          console.error("Error saving document: ", error);
          showMessage('خطا در ذخیره پیام. لطفا دوباره تلاش کنید.', 'error');
          submitButton.disabled = false;
          submitButton.textContent = currentEditId ? 'به‌روزرسانی پیام 🔄' : 'ارسال پیام ✨';
        }
      } else {
        showMessage('لطفاً نام و پیام خود را وارد کنید.', 'error');
      }
    });

    cancelEditButton.addEventListener('click', () => {
        resetForm();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    function loadNotesForAdmin() {
        if (!activeBoardId) return;
        if (unsubscribeNotesListener) { // Detach previous listener if exists
            unsubscribeNotesListener();
        }
        const notesPath = `artifacts/${activeBoardId}/public/data/stickyNotes`;
        const q = query(collection(db, notesPath), orderBy('timestamp', 'desc'));

        unsubscribeNotesListener = onSnapshot(q, (snapshot) => {
            adminNotesListDiv.innerHTML = '';
            if (snapshot.empty) {
                adminNotesListDiv.innerHTML = `<p style="text-align:center; color:#777;">هنوز پیامی برای تخته "${activeBoardId}" ثبت نشده است.</p>`;
                return;
            }
            snapshot.forEach((docSnap) => {
                createAdminNoteElement(docSnap.data(), docSnap.id);
            });
        }, (error) => {
            console.error(`Error fetching notes for admin (board: ${activeBoardId}): `, error);
            showMessage("خطا در بارگذاری لیست پیام‌ها.", "error");
        });
    }

    function createAdminNoteElement(note, noteId) {
        const item = document.createElement('div');
        item.classList.add('admin-note-item');
        item.dataset.id = noteId;
        // (Rest of the element creation logic is the same as your previous admin page)
        const contentDiv = document.createElement('div');
        contentDiv.classList.add('note-content');
        const nameEl = document.createElement('div');
        nameEl.classList.add('note-name'); nameEl.textContent = note.name; contentDiv.appendChild(nameEl);
        const messageEl = document.createElement('div');
        messageEl.classList.add('note-message'); messageEl.textContent = note.message; contentDiv.appendChild(messageEl);
        if (note.imageURL) {
            const imageEl = document.createElement('div');
            imageEl.classList.add('note-image-url'); imageEl.innerHTML = `<strong>لینک عکس:</strong> ${note.imageURL}`; contentDiv.appendChild(imageEl);
        }
        const timestamp = note.timestamp ? note.timestamp.toDate().toLocaleString('fa-IR') : 'نامشخص';
        const timestampEl = document.createElement('div');
        timestampEl.style.fontSize = '0.8rem'; timestampEl.style.color = '#888';
        timestampEl.textContent = `تاریخ: ${timestamp}`; contentDiv.appendChild(timestampEl);
        item.appendChild(contentDiv);
        const actionsDiv = document.createElement('div'); actionsDiv.classList.add('note-actions');
        const editButton = document.createElement('button');
        editButton.classList.add('edit-button'); editButton.textContent = 'ویرایش';
        editButton.addEventListener('click', () => {
            formMainTitle.textContent = `📝 ویرایش پیام در تخته "${activeBoardId}" 📝`;
            nameField.value = note.name; messageField.value = note.message; imageURLField.value = note.imageURL || '';
            noteIdField.value = noteId; currentEditId = noteId;
            submitButton.textContent = 'به‌روزرسانی پیام 🔄'; cancelEditButton.style.display = 'inline-block';
            window.scrollTo({ top: 0, behavior: 'smooth' }); nameField.focus();
        });
        const deleteButton = document.createElement('button');
        deleteButton.classList.add('delete-button'); deleteButton.textContent = 'حذف';
        deleteButton.addEventListener('click', async () => {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;direction:rtl;';
            const modalContent = document.createElement('div');
            modalContent.style.cssText = "background-color:white;padding:20px;border-radius:8px;text-align:center;font-family:'Vazirmatn',sans-serif;";
            const messageP = document.createElement('p');
            messageP.textContent = `آیا از حذف پیام "${note.name}" از تخته "${activeBoardId}" مطمئن هستید؟`; messageP.style.marginBottom = '20px'; modalContent.appendChild(messageP);
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = 'بله، حذف کن'; confirmBtn.style.cssText = 'background-color:#f44336;color:white;border:none;padding:10px 15px;border-radius:5px;margin-left:10px;cursor:pointer;';
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'انصراف'; cancelBtn.style.cssText = 'background-color:#ccc;border:none;padding:10px 15px;border-radius:5px;cursor:pointer;';
            confirmBtn.onclick = async () => {
                document.body.removeChild(modal);
                try {
                    const notesPath = `artifacts/${activeBoardId}/public/data/stickyNotes`;
                    await deleteDoc(doc(db, notesPath, noteId));
                    showMessage('پیام با موفقیت حذف شد.', 'success');
                } catch (error) { console.error("Error deleting document: ", error); showMessage('خطا در حذف پیام.', 'error'); }
            };
            cancelBtn.onclick = () => { document.body.removeChild(modal); };
            modalContent.appendChild(confirmBtn); modalContent.appendChild(cancelBtn);
            modal.appendChild(modalContent); document.body.appendChild(modal);
        });
        actionsDiv.appendChild(editButton); actionsDiv.appendChild(deleteButton); item.appendChild(actionsDiv);
        adminNotesListDiv.appendChild(item);
    }

    // Check for boardId in URL on initial load
    const initialBoardId = getBoardIdFromURL();
    if (initialBoardId) {
        boardIdInputField.value = initialBoardId; // Pre-fill if came from link
        initializeBoard(sanitizeBoardId(initialBoardId));
    } else {
        boardSelectorWrapper.style.display = 'block';
        boardManagementArea.style.display = 'none';
    }

  </script>
</body>
</html>
