<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ØªØ®ØªÙ‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ ØªØ¨Ø±ÛŒÚ©</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollToPlugin.min.js"></script>
  <style>
    body {
      background-image: url('https://www.transparenttextures.com/patterns/light-paper-fibers.png'), linear-gradient(to bottom right, #ffecd2, #fcb69f);
      background-attachment: fixed;
      scroll-behavior: smooth;
    }
    .app-title {
      font-size: 2.5rem;
      color: #d81b60;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      padding: 10px 20px;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .board-info {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.2rem;
      color: #555;
      background-color: rgba(255,255,255,0.7);
      padding: 8px;
      border-radius: 8px;
      display: inline-block; /* Center the block */
    }
    header { /* Ensure header itself is a block for centering its content */
        display: block;
        text-align: center;
    }
    .main-footer {
        text-align: center;
        padding: 20px;
        margin-top: 40px;
        font-family: 'Vazirmatn', sans-serif;
        color: #555;
        font-size: 0.9rem;
        background-color: rgba(255, 255, 255, 0.5);
        border-top: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <header>
    <h1 class="app-title" id="page-title">ğŸ‰ ØªØ®ØªÙ‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ ØªØ¨Ø±ÛŒÚ©! ğŸ‚</h1>
    <div id="board-info-container">
        </div>
  </header>

  <div id="notes-container">
    </div>
  
  <footer class="main-footer">
    Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ Ø¹Ø´Ù‚ ØªÙˆØ³Ø· Ø§Ù…ÛŒØ¯ Ùˆ Ù…Ù‡Ù„Ø§ â¤ï¸
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    gsap.registerPlugin(ScrollToPlugin);

    const firebaseConfig = { // Using your provided config
      apiKey: "AIzaSyBux-_Rlnw0nIv-F1dSdcRAbvLPSSTpZ8I",
      authDomain: "sticky-e06b0.firebaseapp.com",
      projectId: "sticky-e06b0",
      storageBucket: "sticky-e06b0.firebasestorage.app",
      messagingSenderId: "632807722451",
      appId: "1:632807722451:web:be9d003c442eb14987f326"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const notesContainer = document.getElementById('notes-container');
    const pageTitle = document.getElementById('page-title');
    const boardInfoContainer = document.getElementById('board-info-container');


    let currentBoardId = 'default-birthday-board'; // Default board for existing notes

    // --- Auto-scroll variables ---
    let autoScrollAnimation;
    const SCROLL_SPEED_FACTOR = 0.02;
    let resumeScrollTimeout;
    const MIN_NOTES_FOR_AUTOSCROLL = 6; 
    const USER_INTERACTION_PAUSE_DURATION = 7000;
    const DELAY_AT_ENDS_OF_SCROLL = 3000;

    function getBoardIdFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('boardId');
    }

    function updatePageTitleAndInfo(boardId) {
        const displayBoardId = boardId === 'default-birthday-board' ? 'Ø¹Ù…ÙˆÙ…ÛŒ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶)' : boardId;
        pageTitle.textContent = `ğŸ‰ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ØªØ¨Ø±ÛŒÚ© Ø¨Ø±Ø§ÛŒ ${displayBoardId}! ğŸ‚`;
        
        boardInfoContainer.innerHTML = ''; // Clear previous
        const infoEl = document.createElement('div');
        infoEl.classList.add('board-info');
        // Removed the link to manage.html
        infoEl.innerHTML = `Ø´Ù…Ø§ Ø¯Ø± Ø­Ø§Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªØ®ØªÙ‡: <strong>${displayBoardId}</strong> Ù‡Ø³ØªÛŒØ¯.`;
        boardInfoContainer.appendChild(infoEl);
    }


    function loadNotes() {
      const boardIdFromURL = getBoardIdFromURL();
      if (boardIdFromURL) {
        currentBoardId = boardIdFromURL;
      }
      updatePageTitleAndInfo(currentBoardId);

      const notesCollectionPath = `artifacts/${currentBoardId}/public/data/stickyNotes`;
      const q = query(collection(db, notesCollectionPath), orderBy('timestamp', 'desc'));

      onSnapshot(q, (snapshot) => {
        const notesExist = notesContainer.children.length > 0;
        const animateOutCallback = () => {
            notesContainer.innerHTML = ''; 
            displayNotes(snapshot.docs);
        };

        if (notesExist) {
            gsap.to(".note", {
                opacity: 0, scale: 0.8, duration: 0.3, stagger: 0.05,
                onComplete: animateOutCallback
            });
        } else {
            notesContainer.innerHTML = ''; 
            displayNotes(snapshot.docs);
        }
      }, (error) => {
        console.error(`Error fetching notes for board ${currentBoardId}: `, error);
        notesContainer.innerHTML = `<p style="color: red; text-align: center;">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ ØªØ®ØªÙ‡ "${currentBoardId}". Ù„Ø·ÙØ§Ù‹ Ø§Ø² ØµØ­ÛŒØ­ Ø¨ÙˆØ¯Ù† Ø´Ù†Ø§Ø³Ù‡ ØªØ®ØªÙ‡ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ ÛŒØ§ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.</p>`;
      });
    }

    function displayNotes(docs) {
        if (docs.length === 0) {
            notesContainer.innerHTML = `<p style="text-align: center; color: #555; font-size: 1.2rem;">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù… ØªØ¨Ø±ÛŒÚ©ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªØ®ØªÙ‡ (${currentBoardId}) Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>`;
            if (autoScrollAnimation) autoScrollAnimation.kill();
            return;
        }
        docs.forEach((doc, index) => {
            const data = doc.data();
            createNoteElement(data, doc.id, index);
        });
        
        setTimeout(() => {
            if (docs.length >= MIN_NOTES_FOR_AUTOSCROLL) {
                initiateAutoScroll();
            } else {
                if (autoScrollAnimation) autoScrollAnimation.kill();
            }
        }, 500);
    }

    function createNoteElement(data, id, index) {
      const noteEl = document.createElement('div');
      noteEl.classList.add('note');
      noteEl.dataset.id = id;
      const randomRotation = (Math.random() - 0.5) * 8;
      noteEl.style.transform = `rotate(${randomRotation}deg)`;

      const avatarContainer = document.createElement('div');
      avatarContainer.classList.add('avatar-container');
      const avatarImg = document.createElement('img');
      avatarImg.src = data.imageURL || `https://placehold.co/60x60/FFC107/FFFFFF?text=${data.name.substring(0,1).toUpperCase()}&font=Vazirmatn`;
      avatarImg.alt = `Ø¢ÙˆØ§ØªØ§Ø± ${data.name}`;
      avatarImg.onerror = function() {
          this.src = `https://placehold.co/60x60/4CAF50/FFFFFF?text=${data.name.substring(0,1).toUpperCase()}&font=Vazirmatn`;
          this.alt = `Ø¢ÙˆØ§ØªØ§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø±Ø§ÛŒ ${data.name}`;
      };
      avatarContainer.appendChild(avatarImg);
      noteEl.appendChild(avatarContainer);

      const nameEl = document.createElement('div');
      nameEl.classList.add('name');
      nameEl.textContent = data.name;
      noteEl.appendChild(nameEl);

      const msgEl = document.createElement('p');
      msgEl.classList.add('message');
      msgEl.textContent = data.message;
      noteEl.appendChild(msgEl);

      if (data.timestamp && data.timestamp.toDate) {
        const dateEl = document.createElement('div');
        dateEl.classList.add('timestamp');
        dateEl.textContent = data.timestamp.toDate().toLocaleDateString('fa-IR', { day: 'numeric', month: 'long' });
        noteEl.appendChild(dateEl);
      }
      
      const pinEl = document.createElement('div');
      pinEl.classList.add('pin');
      noteEl.appendChild(pinEl);

      notesContainer.appendChild(noteEl);

      gsap.fromTo(noteEl,
        { opacity: 0, scale: 0.3, y: 60, rotation: randomRotation - 20 },
        {
          duration: 0.8, opacity: 1, scale: 1, y: 0, rotation: randomRotation,
          ease: 'elastic.out(1, 0.7)', delay: index * 0.15
        }
      );
    }

    function initiateAutoScroll() {
        if (autoScrollAnimation) autoScrollAnimation.kill(); 
        const scrollableHeight = document.documentElement.scrollHeight - window.innerHeight;
        if (scrollableHeight <= 0) return;
        const currentScrollY = window.scrollY;
        const isAtBottom = currentScrollY >= scrollableHeight - 1;
        const isAtTop = currentScrollY <= 1; 
        let targetY = isAtBottom ? 0 : "max"; 
        let duration = Math.abs((targetY === "max" ? scrollableHeight : 0) - currentScrollY) * SCROLL_SPEED_FACTOR;
        if (duration < 5) duration = 5;
        autoScrollAnimation = gsap.to(window, {
            scrollTo: { y: targetY, autoKill: false },
            duration: duration,
            ease: "power1.inOut", 
            onComplete: () => { setTimeout(initiateAutoScroll, DELAY_AT_ENDS_OF_SCROLL); }
        });
    }

    function handleUserInteraction() {
        if (autoScrollAnimation && autoScrollAnimation.isActive()) {
            autoScrollAnimation.pause();
        }
        clearTimeout(resumeScrollTimeout);
        resumeScrollTimeout = setTimeout(() => {
            if (autoScrollAnimation && !autoScrollAnimation.isActive()) {
                initiateAutoScroll();
            }
        }, USER_INTERACTION_PAUSE_DURATION);
    }

    document.addEventListener('DOMContentLoaded', loadNotes);
    window.addEventListener('scroll', handleUserInteraction, { passive: true });
    window.addEventListener('wheel', handleUserInteraction, { passive: true });
    window.addEventListener('touchstart', handleUserInteraction, { passive: true });
    window.addEventListener('mousedown', handleUserInteraction);
  </script>
</body>
</html>
