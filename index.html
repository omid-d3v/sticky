<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>تخته یادداشت‌های تبریک</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollToPlugin.min.js"></script>
  <style>
    body {
      background-image: url('https://www.transparenttextures.com/patterns/light-paper-fibers.png'), linear-gradient(to bottom right, #ffecd2, #fcb69f);
      background-attachment: fixed;
      scroll-behavior: smooth;
    }
    .app-title {
      font-size: 2.5rem;
      color: #d81b60;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      padding: 10px 20px;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .board-info {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.2rem;
      color: #555;
      background-color: rgba(255,255,255,0.7);
      padding: 8px;
      border-radius: 8px;
      display: inline-block;
    }
    header {
        display: block;
        text-align: center;
    }
    .main-footer {
        text-align: center;
        padding: 20px;
        margin-top: 40px;
        font-family: 'Vazirmatn', sans-serif;
        color: #555;
        font-size: 0.9rem;
        background-color: rgba(255, 255, 255, 0.5);
        border-top: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <header>
    <h1 class="app-title" id="page-title">🎉 یادداشت هم تیمی‌هات برای تولدت 🎂</h1>
    <div id="board-info-container">
    </div>
  </header>

  <div id="notes-container">
  </div>
  
  <footer class="main-footer">
    ساخته شده با عشق توسط امید و مهلا ❤️
  </footer>

  <script type="module">
    // ! مهم: این آدرس را با آدرس سرور پروکسی خود در Railway جایگزین کنید
    const PROXY_BASE_URL = 'https://sticky-proxyserver.vercel.app/api'; // مثال: 'https://my-notes-proxy.up.railway.app/api'

    gsap.registerPlugin(ScrollToPlugin);

    const notesContainer = document.getElementById('notes-container');
    const pageTitle = document.getElementById('page-title');
    const boardInfoContainer = document.getElementById('board-info-container');

    let currentBoardId = 'default-birthday-board'; 

    let autoScrollAnimation;
    const SCROLL_SPEED_FACTOR = 0.02;
    let resumeScrollTimeout;
    const MIN_NOTES_FOR_AUTOSCROLL = 6; 
    const USER_INTERACTION_PAUSE_DURATION = 7000;
    const DELAY_AT_ENDS_OF_SCROLL = 3000;

    function getBoardIdFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('boardId');
    }

    function updatePageTitleAndInfo(boardId) {
        const displayBoardId = boardId === 'default-birthday-board' ? 'عمومی (پیش‌فرض)' : boardId;
        pageTitle.textContent = `🎉 پیام‌های تبریک برای ${displayBoardId}! 🎂`;
        
        boardInfoContainer.innerHTML = '';
        const infoEl = document.createElement('div');
        infoEl.classList.add('board-info');
        infoEl.innerHTML = `شما در حال مشاهده تخته: <strong>${displayBoardId}</strong> هستید.`;
        boardInfoContainer.appendChild(infoEl);
    }

    async function loadNotes() {
      const boardIdFromURL = getBoardIdFromURL();
      if (boardIdFromURL && boardIdFromURL.trim() !== '') {
        currentBoardId = boardIdFromURL.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
      }
      // updatePageTitleAndInfo(currentBoardId);
      notesContainer.innerHTML = `<p style="text-align:center; color:#555;">در حال بارگذاری پیام‌ها برای تخته "${currentBoardId}"...</p>`;

      try {
        const response = await fetch(`${PROXY_BASE_URL}/notes/${currentBoardId}`);
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({error: "خطای ناشناخته در ارتباط با سرور پروکسی"}));
          throw new Error(errorData.error || `خطای سرور پروکسی: ${response.status}`);
        }
        const notes = await response.json();
        displayNotes(notes);
      } catch (error) {
        console.error(`Error fetching notes for board ${currentBoardId} via proxy: `, error);
        notesContainer.innerHTML = `<p style="color: red; text-align: center;">خطا در بارگذاری یادداشت‌ها برای تخته "${currentBoardId}". ${error.message}</p>`;
      }
    }

    function displayNotes(docs) {
        notesContainer.innerHTML = ''; // Clear loading/previous messages
        if (!docs || docs.length === 0) {
            notesContainer.innerHTML = `<p style="text-align: center; color: #555; font-size: 1.2rem;">هنوز هیچ پیام تبریکی برای این تخته (${currentBoardId}) ثبت نشده است.</p>`;
            if (autoScrollAnimation) autoScrollAnimation.kill();
            return;
        }
        docs.forEach((doc, index) => {
            // Assuming 'doc' from proxy already has 'id' and data fields directly
            createNoteElement(doc, doc.id, index); 
        });
        
        setTimeout(() => {
            if (docs.length >= MIN_NOTES_FOR_AUTOSCROLL) {
                initiateAutoScroll();
            } else {
                if (autoScrollAnimation) autoScrollAnimation.kill();
            }
        }, 500);
    }

    function createNoteElement(data, id, index) {
      const noteEl = document.createElement('div');
      noteEl.classList.add('note');
      noteEl.dataset.id = id;
      const randomRotation = (Math.random() - 0.5) * 8;
      noteEl.style.transform = `rotate(${randomRotation}deg)`;

      const avatarContainer = document.createElement('div');
      avatarContainer.classList.add('avatar-container');
      const avatarImg = document.createElement('img');
      avatarImg.src = data.imageURL || `https://placehold.co/60x60/FFC107/FFFFFF?text=${data.name.substring(0,1).toUpperCase()}&font=Vazirmatn`;
      avatarImg.alt = `آواتار ${data.name}`;
      avatarImg.onerror = function() {
          this.src = `https://placehold.co/60x60/4CAF50/FFFFFF?text=${data.name.substring(0,1).toUpperCase()}&font=Vazirmatn`;
          this.alt = `آواتار پیش‌فرض برای ${data.name}`;
      };
      avatarContainer.appendChild(avatarImg);
      noteEl.appendChild(avatarContainer);

      const nameEl = document.createElement('div');
      nameEl.classList.add('name');
      nameEl.textContent = data.name;
      noteEl.appendChild(nameEl);

      const msgEl = document.createElement('p');
      msgEl.classList.add('message');
      msgEl.textContent = data.message;
      noteEl.appendChild(msgEl);

      // Timestamps from Firestore via proxy are objects, need to convert if they exist and are valid
      let formattedTimestamp = 'نامشخص';
      if (data.timestamp && data.timestamp._seconds) { // Firestore timestamp object from Admin SDK via proxy
            formattedTimestamp = new Date(data.timestamp._seconds * 1000).toLocaleString('fa-IR', { day: 'numeric', month: 'long' });
      } else if (typeof data.timestamp === 'string' && data.timestamp.includes("Pending")) {
          formattedTimestamp = "درحال ثبت توسط سرور";
      } else if (data.timestamp) { // If it's already a string or number from a previous fetch
          try { formattedTimestamp = new Date(data.timestamp).toLocaleString('fa-IR', { day: 'numeric', month: 'long' }); } catch (e) { /* ignore */ }
      }

      if (formattedTimestamp !== 'نامشخص') {
        const dateEl = document.createElement('div');
        dateEl.classList.add('timestamp');
        dateEl.textContent = formattedTimestamp;
        noteEl.appendChild(dateEl);
      }
      
      const pinEl = document.createElement('div');
      pinEl.classList.add('pin');
      noteEl.appendChild(pinEl);

      notesContainer.appendChild(noteEl);

      gsap.fromTo(noteEl,
        { opacity: 0, scale: 0.3, y: 60, rotation: randomRotation - 20 },
        {
          duration: 0.8, opacity: 1, scale: 1, y: 0, rotation: randomRotation,
          ease: 'elastic.out(1, 0.7)', delay: index * 0.15
        }
      );
    }

    function initiateAutoScroll() {
        if (autoScrollAnimation) autoScrollAnimation.kill(); 
        const scrollableHeight = document.documentElement.scrollHeight - window.innerHeight;
        if (scrollableHeight <= 0) return;
        const currentScrollY = window.scrollY;
        const isAtBottom = currentScrollY >= scrollableHeight - 1;
        const isAtTop = currentScrollY <= 1; 
        let targetY = isAtBottom ? 0 : "max"; 
        let duration = Math.abs((targetY === "max" ? scrollableHeight : 0) - currentScrollY) * SCROLL_SPEED_FACTOR;
        if (duration < 5) duration = 5;
        autoScrollAnimation = gsap.to(window, {
            scrollTo: { y: targetY, autoKill: false },
            duration: duration,
            ease: "power1.inOut", 
            onComplete: () => { setTimeout(initiateAutoScroll, DELAY_AT_ENDS_OF_SCROLL); }
        });
    }

    function handleUserInteraction() {
        if (autoScrollAnimation && autoScrollAnimation.isActive()) {
            autoScrollAnimation.pause();
        }
        clearTimeout(resumeScrollTimeout);
        resumeScrollTimeout = setTimeout(() => {
            if (autoScrollAnimation && !autoScrollAnimation.isActive()) {
                initiateAutoScroll();
            }
        }, USER_INTERACTION_PAUSE_DURATION);
    }

    document.addEventListener('DOMContentLoaded', loadNotes);
    window.addEventListener('scroll', handleUserInteraction, { passive: true });
    window.addEventListener('wheel', handleUserInteraction, { passive: true });
    window.addEventListener('touchstart', handleUserInteraction, { passive: true });
    window.addEventListener('mousedown', handleUserInteraction);
  </script>
</body>
</html>
